<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Orphanage - Child Management</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/js/select2.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.13/css/select2.min.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: 20px auto;
      padding: 0 20px;
    }
    .back-to-dashboard {
      margin-bottom: 20px;
    }
    h2 {
      color: #333;
      text-align: center;
      margin-bottom: 20px;
    }
    .form-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      margin-bottom: 20px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-group textarea {
      height: 100px;
      resize: vertical;
    }
    .action-buttons {
      display: flex;
      gap: 10px;
    }
    button {
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    button[type="submit"] {
      background-color: #28a745;
      color: #fff;
    }
    button.secondary {
      background-color: #6c757d;
      color: #fff;
    }
    button:hover {
      opacity: 0.9;
    }
    .tab-container {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .tab-buttons {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    .tab-button {
      padding: 10px 20px;
      border: none;
      background: #e9ecef;
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .tab-button.active {
      background: #007bff;
      color: #fff;
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    .export-buttons {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .export-buttons button {
      background: #007bff;
      color: #fff;
    }
    .filter-section {
      margin-bottom: 20px;
    }
    .filter-controls {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .filter-control {
      flex: 1;
      min-width: 200px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }
    th {
      background: #f8f9fa;
      font-weight: bold;
    }
    .action-buttons button {
      padding: 5px 10px;
      font-size: 12px;
    }
    .action-buttons .edit {
      background: #ffc107;
      color: #fff;
    }
    .action-buttons .delete {
      background: #dc3545;
      color: #fff;
    }
    .no-data {
      text-align: center;
      color: #777;
    }
    .select2-container {
      width: 100% !important;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="back-to-dashboard">
      <button onclick="window.location.href='dashboard.html'" class="secondary">
        <i class="fas fa-arrow-left"></i> Back to Dashboard
      </button>
    </div>

    <h2><i class="fas fa-child"></i> Smart Orphanage - Child Management</h2>

    <div class="form-container">
      <form id="childForm">
        <input type="hidden" id="childId">
        <div class="form-group">
          <label for="name">Full Name</label>
          <input type="text" id="name" placeholder="Enter child's full name" required>
        </div>
        <div class="form-group">
          <label for="dob">Date of Birth</label>
          <input type="date" id="dob" required>
        </div>
        <div class="form-group">
          <label for="gender">Gender</label>
          <select id="gender" required>
            <option value="">Select gender</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label for="admissionDate">Admission Date</label>
          <input type="date" id="admissionDate" required>
        </div>
        <div class="form-group">
          <label for="joinedBy">Joined By</label>
          <input type="text" id="joinedBy" placeholder="Enter who referred the child">
        </div>
        <div class="form-group">
          <label for="mobileNumber">Mobile Number</label>
          <input type="tel" id="mobileNumber" placeholder="Enter contact number">
        </div>
        <div class="form-group">
          <label for="notes">Special Notes</label>
          <textarea id="notes" placeholder="Any special notes about the child"></textarea>
        </div>
        <div class="form-group">
          <label for="summary">Summary</label>
          <textarea id="summary" placeholder="Summary about the child"></textarea>
        </div>
        <div class="action-buttons">
          <button type="submit"><i class="fas fa-save"></i> Save Child</button>
          <button type="button" onclick="clearForm()" class="secondary"><i class="fas fa-times"></i> Clear Form</button>
        </div>
      </form>
    </div>

    <div class="tab-container">
      <div class="tab-buttons">
        <button class="tab-button active" data-tab="basicInfo"><i class="fas fa-info-circle"></i> Basic Info</button>
        <button class="tab-button" data-tab="medical"><i class="fas fa-heartbeat"></i> Medical</button>
        <button class="tab-button" data-tab="education"><i class="fas fa-graduation-cap"></i> Education</button>
        
      </div>
      
      <div id="basicInfo" class="tab-content active">
        <div class="export-buttons">
          <button onclick="downloadAllPDF()"><i class="fas fa-file-pdf"></i> Export All to PDF</button>
          <button onclick="downloadExcel()"><i class="fas fa-file-excel"></i> Export to Excel</button>
        </div>

        <h3><i class="fas fa-list"></i> Child List</h3>
        
        <div class="filter-section">
          <h4><i class="fas fa-filter"></i> Filter Children</h4>
          <div class="filter-controls">
            <div class="filter-control">
              <label for="filterName">Name</label>
              <input type="text" id="filterName" placeholder="Filter by name" oninput="applyFilters('basicInfo')">
            </div>
            <div class="filter-control">
              <label for="filterGender">Gender</label>
              <select id="filterGender" onchange="applyFilters('basicInfo')">
                <option value="">All Genders</option>
                <option value="Male">Male</option>
                <option value="Female">Female</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="filterJoinedBy">Joined By</label>
              <input type="text" id="filterJoinedBy" placeholder="Filter by Joined By" oninput="applyFilters('basicInfo')">
            </div>
            <div class="form-group">
              <label for="filterMobileNumber">Mobile Number</label>
              <input type="tel" id="filterMobileNumber" placeholder="Filter by Mobile Number" oninput="applyFilters('basicInfo')">
            </div>
            <div class="filter-control">
              <label for="filterAdmissionYear">Admission Year</label>
              <input type="number" id="filterAdmissionYear" placeholder="e.g., 2023" min="1900" max="2100" oninput="applyFilters('basicInfo')">
            </div>
          </div>
        </div>

        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>Date of Birth</th>
              <th>Gender</th>
              <th>Admission Date</th>
              <th>Joined By</th>
              <th>Mobile Number</th>
              <th>Notes</th>
              <th>Summary</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="childTableBody"></tbody>
        </table>
      </div>

      <div id="medical" class="tab-content">
        <h3><i class="fas fa-heartbeat"></i> Medical Records</h3>
        <div class="filter-section">
          <h4><i class="fas fa-filter"></i> Filter Medical Records</h4>
          <div class="filter-controls">
            <div class="filter-control">
              <label for="filterMedicalChild">Child</label>
              <select id="filterMedicalChild" class="searchable" onchange="applyFilters('medical')">
                <option value="">All Children</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterMedicalType">Type</label>
              <select id="filterMedicalType" onchange="applyFilters('medical')">
                <option value="">All Types</option>
                <option value="Checkup">Checkup</option>
                <option value="Vaccination">Vaccination</option>
                <option value="Illness">Illness</option>
                <option value="Allergy">Allergy</option>
                <option value="Medication">Medication</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterMedicalYear">Year</label>
              <input type="number" id="filterMedicalYear" placeholder="e.g., 2023" min="1900" max="2100" oninput="applyFilters('medical')">
            </div>
          </div>
        </div>
        <div class="form-container">
          <form id="medicalForm">
            <input type="hidden" id="medicalId">
            <div class="form-group">
              <label for="medicalChild">Child</label>
              <select id="medicalChild" class="searchable" required></select>
            </div>
            <div class="form-group">
              <label for="medicalDate">Date</label>
              <input type="date" id="medicalDate" required>
            </div>
            <div class="form-group">
              <label for="medicalType">Type</label>
              <select id="medicalType" required>
                <option value="">Select type</option>
                <option value="Checkup">Checkup</option>
                <option value="Vaccination">Vaccination</option>
                <option value="Illness">Illness</option>
                <option value="Allergy">Allergy</option>
                <option value="Medication">Medication</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div class="form-group">
              <label for="medicalDescription">Description</label>
              <textarea id="medicalDescription" required placeholder="Describe the medical event"></textarea>
            </div>
            <div class="form-group">
              <label for="medicalSummary">Summary</label>
              <textarea id="medicalSummary" placeholder="Summary of the medical record"></textarea>
            </div>
            <div class="form-group">
              <label for="medicalNotes">Notes</label>
              <textarea id="medicalNotes" placeholder="Additional notes"></textarea>
            </div>
            <div class="action-buttons">
              <button type="submit"><i class="fas fa-save"></i> Save Medical Record</button>
              <button type="button" onclick="clearMedicalForm()" class="secondary"><i class="fas fa-times"></i> Clear</button>
            </div>
          </form>
        </div>
        <table>
          <thead>
            <tr>
              <th>Child</th>
              <th>Date</th>
              <th>Type</th>
              <th>Description</th>
              <th>Summary</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="medicalTableBody"></tbody>
        </table>
      </div>

      <div id="education" class="tab-content">
        <h3><i class="fas fa-graduation-cap"></i> Education Records</h3>
        <div class="filter-section">
          <h4><i class="fas fa-filter"></i> Filter Education Records</h4>
          <div class="filter-controls">
            <div class="filter-control">
              <label for="filterEducationChild">Child</label>
              <select id="filterEducationChild" class="searchable" onchange="applyFilters('education')">
                <option value="">All Children</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterEducationLevel">Level</label>
              <select id="filterEducationLevel" onchange="applyFilters('education')">
                <option value="">All Levels</option>
                <option value="Preschool">Preschool</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="High School">High School</option>
                <option value="Vocational">Vocational</option>
                <option value="University">University</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterAcademicYear">Academic Year</label>
              <input type="text" id="filterAcademicYear" placeholder="e.g., 2023-2024" oninput="applyFilters('education')">
            </div>
          </div>
        </div>
        <div class="form-container">
          <form id="educationForm">
            <input type="hidden" id="educationId">
            <div class="form-group">
              <label for="educationChild">Child</label>
              <select id="educationChild" class="searchable" required></select>
            </div>
            <div class="form-group">
              <label for="academicYear">Academic Year</label>
              <input type="text" id="academicYear" placeholder="e.g., 2023-2024" required>
            </div>
            <div class="form-group">
              <label for="educationLevel">Education Level</label>
              <select id="educationLevel" required>
                <option value="">Select level</option>
                <option value="Preschool">Preschool</option>
                <option value="Primary">Primary</option>
                <option value="Secondary">Secondary</option>
                <option value="High School">High School</option>
                <option value="Vocational">Vocational</option>
                <option value="University">University</option>
              </select>
            </div>
            <div class="form-group">
              <label for="school">School</label>
              <input type="text" id="school" placeholder="Enter school name" required>
            </div>
            <div class="form-group">
              <label for="performance">Performance</label>
              <select id="performance" required>
                <option value="">Select performance</option>
                <option value="Excellent">Excellent</option>
                <option value="Good">Good</option>
                <option value="Average">Average</option>
                <option value="Needs Improvement">Needs Improvement</option>
              </select>
            </div>
            <div class="form-group">
              <label for="educationSummary">Summary</label>
              <textarea id="educationSummary" placeholder="Summary of the education record"></textarea>
            </div>
            <div class="form-group">
              <label for="educationNotes">Notes</label>
              <textarea id="educationNotes" placeholder="Additional notes"></textarea>
            </div>
            <div class="action-buttons">
              <button type="submit"><i class="fas fa-save"></i> Save Education Record</button>
              <button type="button" onclick="clearEducationForm()" class="secondary"><i class="fas fa-times"></i> Clear</button>
            </div>
          </form>
        </div>
        <table>
          <thead>
            <tr>
              <th>Child</th>
              <th>Academic Year</th>
              <th>Level</th>
              <th>School</th>
              <th>Performance</th>
              <th>Summary</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="educationTableBody"></tbody>
        </table>
      </div>

      <div id="sponsorship" class="tab-content">
        <h3><i class="fas fa-hand-holding-heart"></i> Sponsorship Records</h3>
        <div class="filter-section">
          <h4><i class="fas fa-filter"></i> Filter Sponsorship Records</h4>
          <div class="filter-controls">
            <div class="filter-control">
              <label for="filterSponsorChild">Child</label>
              <select id="filterSponsorChild" class="searchable" onchange="applyFilters('sponsorship')">
                <option value="">All Children</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterSponsorType">Sponsor Type</label>
              <select id="filterSponsorType" onchange="applyFilters('sponsorship')">
                <option value="">All Types</option>
                <option value="Sponsor">Sponsor</option>
                <option value="Guardian">Guardian</option>
                <option value="Foster Parent">Foster Parent</option>
              </select>
            </div>
            <div class="filter-control">
              <label for="filterSponsorName">Sponsor Name</label>
              <input type="text" id="filterSponsorName" placeholder="Filter by sponsor name" oninput="applyFilters('sponsorship')">
            </div>
          </div>
        </div>
        <div class="form-container">
          <form id="sponsorForm">
            <input type="hidden" id="sponsorId">
            <div class="form-group">
              <label for="sponsorChild">Child</label>
              <select id="sponsorChild" class="searchable" required></select>
            </div>
            <div class="form-group">
              <label for="sponsorType">Sponsor Type</label>
              <select id="sponsorType" required>
                <option value="">Select type</option>
                <option value="Sponsor">Sponsor</option>
                <option value="Guardian">Guardian</option>
                <option value="Foster Parent">Foster Parent</option>
              </select>
            </div>
            <div class="form-group">
              <label for="sponsorName">Sponsor Name</label>
              <input type="text" id="sponsorName" placeholder="Enter sponsor name" required>
            </div>
            <div class="form-group">
              <label for="sponsorContact">Contact</label>
              <input type="text" id="sponsorContact" placeholder="Enter contact info" required>
            </div>
            <div class="form-group">
              <label for="startDate">Start Date</label>
              <input type="date" id="startDate">
            </div>
            <div class="form-group">
              <label for="endDate">End Date</label>
              <input type="date" id="endDate">
            </div>
            <div class="form-group">
              <label for="sponsorSummary">Summary</label>
              <textarea id="sponsorSummary" placeholder="Summary of the sponsorship"></textarea>
            </div>
            <div class="form-group">
              <label for="sponsorNotes">Notes</label>
              <textarea id="sponsorNotes" placeholder="Additional notes"></textarea>
            </div>
            <div class="action-buttons">
              <button type="submit"><i class="fas fa-save"></i> Save Sponsor Record</button>
              <button type="button" onclick="clearSponsorForm()" class="secondary"><i class="fas fa-times"></i> Clear</button>
            </div>
          </form>
        </div>
        <table>
          <thead>
            <tr>
              <th>Child</th>
              <th>Sponsor Type</th>
              <th>Sponsor Name</th>
              <th>Contact</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Summary</th>
              <th>Notes</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="sponsorTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    const { jsPDF } = window.jspdf;
    const token = localStorage.getItem('token');
    let editingChildId = null;

    // Initialize Select2 for searchable dropdowns
    $(document).ready(function() {
      $('.searchable').select2({
        placeholder: 'Select a child',
        allowClear: true,
        width: '100%'
      });
    });

    // Tab switching
    document.querySelectorAll('.tab-button').forEach(button => {
      button.addEventListener('click', () => {
        document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
        button.classList.add('active');
        document.getElementById(button.dataset.tab).classList.add('active');
        if (button.dataset.tab !== 'basicInfo') {
          loadRecords(button.dataset.tab);
        } else {
          loadChildren();
        }
      });
    });

    // Fetch and update dashboard counts
    async function updateDashboardCounts() {
      try {
        const response = await fetch('http://localhost:5001/api/dashboard/counts', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to update dashboard counts');
      } catch (error) {
        console.error('Error updating dashboard counts:', error);
      }
    }

    // Fetch children
    async function fetchChildren() {
      try {
        const response = await fetch('http://localhost:5001/api/children', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch children');
        return await response.json();
      } catch (error) {
        console.error('Error fetching children:', error);
        return [];
      }
    }

    // Load children into table and select options
    async function loadChildren() {
      const children = await fetchChildren();
      const tableBody = document.getElementById('childTableBody');
      const selectElements = [
        document.getElementById('medicalChild'),
        document.getElementById('educationChild'),
        document.getElementById('sponsorChild'),
        document.getElementById('filterMedicalChild'),
        document.getElementById('filterEducationChild'),
        document.getElementById('filterSponsorChild')
      ];

      tableBody.innerHTML = '';
      selectElements.forEach(select => {
        select.innerHTML = '<option value="">Select child</option>';
        if (select.id.startsWith('filter')) {
          select.innerHTML = '<option value="">All Children</option>';
        }
      });

      if (children.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="9" class="no-data">No children found.</td></tr>';
        return;
      }

      children.forEach(child => {
        tableBody.innerHTML += `
          <tr data-child-id="${child.id}">
            <td>${child.name}</td>
            <td>${formatDate(child.dob)}</td>
            <td>${child.gender}</td>
            <td>${formatDate(child.admission_date)}</td>
            <td>${child.joined_by || '-'}</td>
            <td>${child.mobile_number || '-'}</td>
            <td>${child.notes || '-'}</td>
            <td>${child.summary || '-'}</td>
            <td class="action-buttons">
              <button class="edit" onclick="editChild('${child.id}')"><i class="fas fa-edit"></i> Edit</button>
              <button class="delete" onclick="deleteChild('${child.id}')"><i class="fas fa-trash"></i> Delete</button>
            </td>
          </tr>
        `;
        selectElements.forEach(select => {
          const option = document.createElement('option');
          option.value = child.id;
          option.textContent = child.name;
          select.appendChild(option);
        });
      });

      // Reinitialize Select2 after adding options
      $('.searchable').select2({
        placeholder: 'Select a child',
        allowClear: true,
        width: '100%'
      });

      applyFilters('basicInfo');
    }

    // Edit child
    async function editChild(id) {
      console.log('Editing child with ID:', id); // Debugging
      const children = await fetchChildren();
      console.log('Children data:', children); // Debugging
      const child = children.find(c => c.id == id);
      console.log('Selected child:', child); // Debugging
      if (child) {
        editingChildId = id;
        document.getElementById('childId').value = id;
        document.getElementById('name').value = child.name || '';
        document.getElementById('dob').value = child.dob || '';
        document.getElementById('gender').value = child.gender || '';
        document.getElementById('admissionDate').value = child.admission_date || '';
        document.getElementById('joinedBy').value = child.joined_by || '';
        document.getElementById('mobileNumber').value = child.mobile_number || '';
        document.getElementById('notes').value = child.notes || '';
        document.getElementById('summary').value = child.summary || '';
        document.getElementById('childForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Child';
      } else {
        console.error('Child not found for ID:', id);
        alert('Child not found');
      }
    }

    // Delete child
    async function deleteChild(id) {
      if (confirm('Are you sure you want to delete this child?')) {
        try {
          const response = await fetch(`http://localhost:5001/api/children/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Failed to delete child');
          await loadChildren();
          await updateDashboardCounts();
          clearForm();
        } catch (error) {
          console.error('Error deleting child:', error);
          alert('Failed to delete child');
        }
      }
    }

    // Child form submission
    document.getElementById('childForm').onsubmit = async (e) => {
      e.preventDefault();
      const child = {
        name: document.getElementById('name').value,
        dob: document.getElementById('dob').value,
        gender: document.getElementById('gender').value,
        admission_date: document.getElementById('admissionDate').value,
        joined_by: document.getElementById('joinedBy').value,
        mobile_number: document.getElementById('mobileNumber').value,
        notes: document.getElementById('notes').value,
        summary: document.getElementById('summary').value
      };
      console.log('Sending child data:', child); // Debugging
      if (!child.name || !child.dob || !child.gender || !child.admission_date) {
        alert('Please fill all required fields');
        return;
      }
      try {
        const url = editingChildId ? `http://localhost:5001/api/children/${editingChildId}` : 'http://localhost:5001/api/children';
        const method = editingChildId ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(child)
        });
        const responseData = await response.json();
        if (!response.ok) throw new Error(responseData.message || 'Failed to save child');
        clearForm();
        await loadChildren();
        await updateDashboardCounts();
      } catch (error) {
        console.error('Error saving child:', error);
        alert(`Failed to save child: ${error.message}`);
      }
    };

    // Clear child form
    function clearForm() {
      document.getElementById('childForm').reset();
      document.getElementById('childId').value = '';
      document.getElementById('summary').value = '';
      editingChildId = null;
      document.getElementById('childForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Child';
    }

    // Fetch all records
    async function fetchRecords(type) {
      try {
        const response = await fetch(`http://localhost:5001/api/${type}-records`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error(`Failed to fetch ${type} records`);
        return await response.json();
      } catch (error) {
        console.error(`Error fetching ${type} records:`, error);
        return [];
      }
    }

    // Load records for medical, education, or sponsorship
    async function loadRecords(type) {
      const tableBody = document.getElementById(`${type}TableBody`);
      tableBody.innerHTML = '';
      const records = await fetchRecords(type);
      const children = await fetchChildren();

      if (records.length === 0) {
        tableBody.innerHTML = `<tr><td colspan="${type === 'sponsorship' ? 9 : 7}" class="no-data">No ${type} records found.</td></tr>`;
        return;
      }

      records.forEach(record => {
        const child = children.find(c => c.id === record.child_id);
        if (type === 'medical') {
          tableBody.innerHTML += `
            <tr data-child-id="${record.child_id}">
              <td>${child ? child.name : '-'}</td>
              <td>${formatDate(record.medical_date)}</td>
              <td>${record.medical_type}</td>
              <td>${record.description}</td>
              <td>${record.summary || '-'}</td>
              <td>${record.notes || '-'}</td>
              <td class="action-buttons">
                <button class="edit" onclick="editMedicalRecord('${record.id}', '${record.child_id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="delete" onclick="deleteRecord('medical', '${record.id}', '${type}')"><i class="fas fa-trash"></i> Delete</button>
              </td>
            </tr>
          `;
        } else if (type === 'education') {
          tableBody.innerHTML += `
            <tr data-child-id="${record.child_id}">
              <td>${child ? child.name : '-'}</td>
              <td>${record.academic_year}</td>
              <td>${record.education_level}</td>
              <td>${record.school}</td>
              <td>${record.performance}</td>
              <td>${record.summary || '-'}</td>
              <td>${record.notes || '-'}</td>
              <td class="action-buttons">
                <button class="edit" onclick="editEducationRecord('${record.id}', '${record.child_id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="delete" onclick="deleteRecord('education', '${record.id}', '${type}')"><i class="fas fa-trash"></i> Delete</button>
              </td>
            </tr>
          `;
        } else if (type === 'sponsorship') {
          tableBody.innerHTML += `
            <tr data-child-id="${record.child_id}">
              <td>${child ? child.name : '-'}</td>
              <td>${record.sponsor_type}</td>
              <td>${record.name}</td>
              <td>${record.contact}</td>
              <td>${formatDate(record.start_date) || '-'}</td>
              <td>${formatDate(record.end_date) || '-'}</td>
              <td>${record.summary || '-'}</td>
              <td>${record.notes || '-'}</td>
              <td class="action-buttons">
                <button class="edit" onclick="editSponsorRecord('${record.id}', '${record.child_id}')"><i class="fas fa-edit"></i> Edit</button>
                <button class="delete" onclick="deleteRecord('sponsorship', '${record.id}', '${type}')"><i class="fas fa-trash"></i> Delete</button>
              </td>
            </tr>
          `;
        }
      });

      applyFilters(type);
    }

    // Apply filters
    function applyFilters(type) {
      if (type === 'basicInfo') {
        const nameFilter = document.getElementById('filterName').value.toLowerCase();
        const genderFilter = document.getElementById('filterGender').value;
        const joinedByFilter = document.getElementById('filterJoinedBy').value.toLowerCase();
        const mobileNumberFilter = document.getElementById('filterMobileNumber').value.toLowerCase();
        const admissionYearFilter = document.getElementById('filterAdmissionYear').value;
        const rows = document.getElementById('childTableBody').querySelectorAll('tr');

        rows.forEach(row => {
          if (row.classList.contains('no-data')) return;
          const name = row.cells[0].textContent.toLowerCase();
          const gender = row.cells[2].textContent;
          const joinedBy = row.cells[4].textContent.toLowerCase();
          const mobileNumber = row.cells[5].textContent.toLowerCase();
          const admissionDate = row.cells[3].textContent;
          const admissionYear = admissionDate ? new Date(admissionDate).getFullYear().toString() : '';

          const matchesName = name.includes(nameFilter);
          const matchesGender = !genderFilter || gender === genderFilter;
          const matchesJoinedBy = joinedBy.includes(joinedByFilter);
          const matchesMobileNumber = mobileNumber.includes(mobileNumberFilter);
          const matchesYear = !admissionYearFilter || admissionYear === admissionYearFilter;

          row.style.display = matchesName && matchesGender && matchesJoinedBy && matchesMobileNumber && matchesYear ? '' : 'none';
        });
      } else if (type === 'medical') {
        const childFilter = document.getElementById('filterMedicalChild').value;
        const typeFilter = document.getElementById('filterMedicalType').value;
        const yearFilter = document.getElementById('filterMedicalYear').value;
        const rows = document.getElementById('medicalTableBody').querySelectorAll('tr');

        rows.forEach(row => {
          if (row.classList.contains('no-data')) return;
          const childId = row.getAttribute('data-child-id');
          const type = row.cells[2].textContent;
          const date = row.cells[1].textContent;
          const year = date ? new Date(date).getFullYear().toString() : '';

          const matchesChild = !childFilter || childId === childFilter;
          const matchesType = !typeFilter || type === typeFilter;
          const matchesYear = !yearFilter || year === yearFilter;

          row.style.display = matchesChild && matchesType && matchesYear ? '' : 'none';
        });
      } else if (type === 'education') {
        const childFilter = document.getElementById('filterEducationChild').value;
        const levelFilter = document.getElementById('filterEducationLevel').value;
        const yearFilter = document.getElementById('filterAcademicYear').value.toLowerCase();
        const rows = document.getElementById('educationTableBody').querySelectorAll('tr');

        rows.forEach(row => {
          if (row.classList.contains('no-data')) return;
          const childId = row.getAttribute('data-child-id');
          const level = row.cells[2].textContent;
          const academicYear = row.cells[1].textContent.toLowerCase();

          const matchesChild = !childFilter || childId === childFilter;
          const matchesLevel = !levelFilter || level === levelFilter;
          const matchesYear = !yearFilter || academicYear.includes(yearFilter);

          row.style.display = matchesChild && matchesLevel && matchesYear ? '' : 'none';
        });
      } else if (type === 'sponsorship') {
        const childFilter = document.getElementById('filterSponsorChild').value;
        const typeFilter = document.getElementById('filterSponsorType').value;
        const nameFilter = document.getElementById('filterSponsorName').value.toLowerCase();
        const rows = document.getElementById('sponsorTableBody').querySelectorAll('tr');

        rows.forEach(row => {
          if (row.classList.contains('no-data')) return;
          const childId = row.getAttribute('data-child-id');
          const type = row.cells[1].textContent;
          const sponsorName = row.cells[2].textContent.toLowerCase();

          const matchesChild = !childFilter || childId === childFilter;
          const matchesType = !typeFilter || type === typeFilter;
          const matchesName = !nameFilter || sponsorName.includes(nameFilter);

          row.style.display = matchesChild && matchesType && matchesName ? '' : 'none';
        });
      }
    }

    // Edit medical record
    async function editMedicalRecord(id, childId) {
      console.log('Editing medical record with ID:', id, 'for child ID:', childId); // Debugging
      const response = await fetch(`http://localhost:5001/api/medical-records/${childId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const records = await response.json();
      console.log('Medical records for child:', records); // Debugging
      const record = Array.isArray(records) ? records.find(r => r.id === id) : records;
      if (record) {
        document.getElementById('medicalId').value = id;
        document.getElementById('medicalChild').value = childId;
        console.log('Setting medicalChild to:', childId); // Debugging
        $('#medicalChild').trigger('change');
        document.getElementById('medicalDate').value = record.medical_date || '';
        document.getElementById('medicalType').value = record.medical_type || '';
        document.getElementById('medicalDescription').value = record.description || '';
        document.getElementById('medicalSummary').value = record.summary || '';
        document.getElementById('medicalNotes').value = record.notes || '';
        document.getElementById('medicalForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Medical Record';
      } else {
        console.error('Medical record not found for ID:', id);
        alert('Medical record not found');
      }
    }

    // Edit education record
    async function editEducationRecord(id, childId) {
      console.log('Editing education record with ID:', id, 'for child ID:', childId); // Debugging
      const response = await fetch(`http://localhost:5001/api/education-records/${childId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const records = await response.json();
      console.log('Education records for child:', records); // Debugging
      const record = Array.isArray(records) ? records.find(r => r.id === id) : records;
      if (record) {
        document.getElementById('educationId').value = id;
        document.getElementById('educationChild').value = childId;
        console.log('Setting educationChild to:', childId); // Debugging
        $('#educationChild').trigger('change');
        document.getElementById('academicYear').value = record.academic_year || '';
        document.getElementById('educationLevel').value = record.education_level || '';
        document.getElementById('school').value = record.school || '';
        document.getElementById('performance').value = record.performance || '';
        document.getElementById('educationSummary').value = record.summary || '';
        document.getElementById('educationNotes').value = record.notes || '';
        document.getElementById('educationForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Education Record';
      } else {
        console.error('Education record not found for ID:', id);
        alert('Education record not found');
      }
    }

    // Edit sponsor record
    async function editSponsorRecord(id, childId) {
      console.log('Editing sponsor record with ID:', id, 'for child ID:', childId); // Debugging
      const response = await fetch(`http://localhost:5001/api/sponsor-records/${childId}`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      const records = await response.json();
      console.log('Sponsor records for child:', records); // Debugging
      const record = Array.isArray(records) ? records.find(r => r.id === id) : records;
      if (record) {
        document.getElementById('sponsorId').value = id;
        document.getElementById('sponsorChild').value = childId;
        console.log('Setting sponsorChild to:', childId); // Debugging
        $('#sponsorChild').trigger('change');
        document.getElementById('sponsorType').value = record.sponsor_type || '';
        document.getElementById('sponsorName').value = record.name || '';
        document.getElementById('sponsorContact').value = record.contact || '';
        document.getElementById('startDate').value = record.start_date || '';
        document.getElementById('endDate').value = record.end_date || '';
        document.getElementById('sponsorSummary').value = record.summary || '';
        document.getElementById('sponsorNotes').value = record.notes || '';
        document.getElementById('sponsorForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Sponsor Record';
      } else {
        console.error('Sponsor record not found for ID:', id);
        alert('Sponsor record not found');
      }
    }

    // Delete record
    async function deleteRecord(type, id, tab) {
      if (confirm(`Are you sure you want to delete this ${type} record?`)) {
        try {
          const response = await fetch(`http://localhost:5001/api/${type}-records/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) throw new Error(`Failed to delete ${type} record`);
          loadRecords(tab);
        } catch (error) {
          console.error(`Error deleting ${type} record:`, error);
          alert(`Failed to delete ${type} record`);
        }
      }
    }

    // Medical form submission
    document.getElementById('medicalForm').onsubmit = async (e) => {
      e.preventDefault();
      const record = {
        child_id: document.getElementById('medicalChild').value,
        medical_date: document.getElementById('medicalDate').value,
        medical_type: document.getElementById('medicalType').value,
        description: document.getElementById('medicalDescription').value,
        summary: document.getElementById('medicalSummary').value,
        notes: document.getElementById('medicalNotes').value
      };
      console.log('Sending medical record data:', record); // Debugging
      try {
        const url = document.getElementById('medicalId').value ? `http://localhost:5001/api/medical-records/${document.getElementById('medicalId').value}` : 'http://localhost:5000/api/medical-records';
        const method = document.getElementById('medicalId').value ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(record)
        });
        if (!response.ok) throw new Error('Failed to save medical record');
        clearMedicalForm();
        loadRecords('medical');
      } catch (error) {
        console.error('Error saving medical record:', error);
        alert('Failed to save medical record');
      }
    };

    // Education form submission
    document.getElementById('educationForm').onsubmit = async (e) => {
      e.preventDefault();
      const record = {
        child_id: document.getElementById('educationChild').value,
        academic_year: document.getElementById('academicYear').value,
        education_level: document.getElementById('educationLevel').value,
        school: document.getElementById('school').value,
        performance: document.getElementById('performance').value,
        summary: document.getElementById('educationSummary').value,
        notes: document.getElementById('educationNotes').value
      };
      console.log('Sending education record data:', record); // Debugging
      try {
        const url = document.getElementById('educationId').value ? `http://localhost:5001/api/education-records/${document.getElementById('educationId').value}` : 'http://localhost:5000/api/education-records';
        const method = document.getElementById('educationId').value ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(record)
        });
        if (!response.ok) throw new Error('Failed to save education record');
        clearEducationForm();
        loadRecords('education');
      } catch (error) {
        console.error('Error saving education record:', error);
        alert('Failed to save education record');
      }
    };

    // Sponsor form submission
    document.getElementById('sponsorForm').onsubmit = async (e) => {
      e.preventDefault();
      const record = {
        child_id: document.getElementById('sponsorChild').value,
        sponsor_type: document.getElementById('sponsorType').value,
        name: document.getElementById('sponsorName').value,
        contact: document.getElementById('sponsorContact').value,
        start_date: document.getElementById('startDate').value,
        end_date: document.getElementById('endDate').value,
        summary: document.getElementById('sponsorSummary').value,
        notes: document.getElementById('sponsorNotes').value
      };
      console.log('Sending sponsor record data:', record); // Debugging
      try {
        const url = document.getElementById('sponsorId').value ? `http://localhost:5001/api/sponsor-records/${document.getElementById('sponsorId').value}` : 'http://localhost:5000/api/sponsor-records';
        const method = document.getElementById('sponsorId').value ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(record)
        });
        if (!response.ok) throw new Error('Failed to save sponsor record');
        clearSponsorForm();
        loadRecords('sponsorship');
      } catch (error) {
        console.error('Error saving sponsor record:', error);
        alert('Failed to save sponsor record');
      }
    };

    // Clear forms
    function clearMedicalForm() {
      document.getElementById('medicalForm').reset();
      document.getElementById('medicalId').value = '';
      document.getElementById('medicalSummary').value = '';
      $('#medicalChild').val('').trigger('change');
      document.getElementById('medicalForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Medical Record';
    }

    function clearEducationForm() {
      document.getElementById('educationForm').reset();
      document.getElementById('educationId').value = '';
      document.getElementById('educationSummary').value = '';
      $('#educationChild').val('').trigger('change');
      document.getElementById('educationForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Education Record';
    }

    function clearSponsorForm() {
      document.getElementById('sponsorForm').reset();
      document.getElementById('sponsorId').value = '';
      document.getElementById('sponsorSummary').value = '';
      $('#sponsorChild').val('').trigger('change');
      document.getElementById('sponsorForm').querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Save Sponsor Record';
    }

    // Export to PDF
    async function downloadAllPDF() {
      const children = await fetchChildren();
      const doc = new jsPDF();
      let yOffset = 10;

      for (const child of children) {
        if (yOffset > 250) {
          doc.addPage();
          yOffset = 10;
        }
        doc.setFontSize(16);
        doc.text(`Child Profile: ${child.name}`, 10, yOffset);
        yOffset += 10;
        doc.setFontSize(12);
        doc.text(`Date of Birth: ${formatDate(child.dob)}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Gender: ${child.gender}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Admission Date: ${formatDate(child.admission_date)}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Joined By: ${child.joined_by || 'None'}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Mobile Number: ${child.mobile_number || 'None'}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Notes: ${child.notes || 'None'}`, 10, yOffset);
        yOffset += 10;
        doc.text(`Summary: ${child.summary || 'None'}`, 10, yOffset);
        yOffset += 20;

        // Medical Records
        doc.setFontSize(14);
        doc.text('Medical Records', 10, yOffset);
        yOffset += 10;
        doc.setFontSize(10);
        const medicalResponse = await fetch(`http://localhost:5001/api/medical-records/${child.id}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const medicalRecords = await medicalResponse.json();
        medicalRecords.forEach(record => {
          if (yOffset > 270) {
            doc.addPage();
            yOffset = 10;
          }
          doc.text(`${formatDate(record.medical_date)} - ${record.medical_type}: ${record.description} (Summary: ${record.summary || 'None'})`, 10, yOffset);
          yOffset += 10;
        });
        yOffset += 10;
      }

      doc.save('children_profiles.pdf');
    }

    // Export to Excel
    async function downloadExcel() {
      const children = await fetchChildren();
      const data = children.map(child => ({
        Name: child.name,
        'Date of Birth': formatDate(child.dob),
        Gender: child.gender,
        'Admission Date': formatDate(child.admission_date),
        'Joined By': child.joined_by || '',
        'Mobile Number': child.mobile_number || '',
        Notes: child.notes || '',
        Summary: child.summary || ''
      }));

      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, 'Children');
      XLSX.writeFile(wb, 'children_data.xlsx');
    }

    // Format date
    function formatDate(dateString) {
      if (!dateString) return '';
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return 'Invalid Date';
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return date.toLocaleDateString(undefined, options);
    }

    // Initialize
    window.onload = () => {
      console.log('Token on load:', token); // Debugging
      if (!token) {
        window.location.href = 'login.html';
      } else {
        loadChildren();
      }
    };
  </script>
</body>
</html>