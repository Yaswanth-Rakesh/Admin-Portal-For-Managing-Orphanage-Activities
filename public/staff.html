<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Orphanage – Staff Dashboard</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 1200px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      position: relative;
    }
    .welcome-message {
      background: #3498db;
      color: white;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 500;
      text-align: center;
    }
    h2 {
      color: #2c3e50;
      border-bottom: 3px solid #3498db;
      padding-bottom: 10px;
      margin-top: 0;
      font-size: 28px;
    }
    .dashboard-btn {
      position: absolute;
      top: 30px;
      right: 30px;
      background: #3498db;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      text-decoration: none;
    }
    .dashboard-btn:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .tabs {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }
    .tabs button {
      flex: 1;
      min-width: 150px;
      padding: 14px;
      border: none;
      border-radius: 8px;
      background: #3498db;
      color: white;
      font-weight: 600;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .tabs button:hover {
      background: #2980b9;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .tabs button i {
      font-size: 18px;
    }
    .section {
      display: none;
      animation: fadeIn 0.5s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .section.active {
      display: block;
    }
    .form-container {
      background: #f8f9fa;
      padding: 25px;
      border-radius: 10px;
      margin-bottom: 30px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    form {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 15px;
      margin-bottom: 0;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 8px;
      font-weight: 500;
      color: #2c3e50;
      font-size: 14px;
    }
    input, select, textarea {
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
      transition: border 0.3s;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
    }
    button.submit {
      background: #2ecc71;
      padding: 12px 24px;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      align-self: end;
      grid-column: 1 / -1;
      max-width: 200px;
    }
    button.submit:hover {
      background: #27ae60;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    button.delete {
      background: #e74c3c;
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }
    button.delete:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    button.edit {
      background: #f39c12;
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      margin-right: 8px;
    }
    button.edit:hover {
      background: #d35400;
      transform: translateY(-1px);
    }
    button.resolve {
      background: #2ecc71;
      padding: 8px 16px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
      margin-right: 8px;
    }
    button.resolve:hover {
      background: #27ae60;
      transform: translateY(-1px);
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td {
      padding: 15px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }
    th {
      background: #3498db;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:hover {
      background-color: #f5f5f5;
    }
    .status-present {
      color: #2ecc71;
      font-weight: 600;
    }
    .status-absent {
      color: #e74c3c;
      font-weight: 600;
    }
    .status-pending {
      color: #f39c12;
      font-weight: 600;
    }
    .status-resolved {
      color: #2ecc71;
      font-weight: 600;
    }
    .status-dismissed {
      color: #7f8c8d;
      font-weight: 600;
    }
    .action-buttons {
      display: flex;
      gap: 8px;
    }
    .no-data {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
      font-style: italic;
    }
    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    .search-box {
      flex: 1;
      min-width: 250px;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    .filter-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .filter-label {
      font-weight: 500;
      color: #2c3e50;
      font-size: 14px;
      white-space: nowrap;
    }
    .filter-select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }
    .bulk-actions {
      margin-bottom: 15px;
      display: none;
    }
    #reportResults table {
      margin-top: 20px;
    }
    #reportCharts {
      width: 100%;
      height: 400px;
      margin-top: 30px;
    }
    .loading {
      text-align: center;
      padding: 20px;
      color: #3498db;
      font-weight: 500;
    }
    .error-message {
      color: #e74c3c;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    .loading-spinner {
      color: #fff;
      font-size: 18px;
      text-align: center;
    }
    .select2-container--default .select2-selection--single {
      border: 1px solid #ddd;
      border-radius: 6px;
      padding: 8px;
      height: 40px;
      font-size: 15px;
    }
    .select2-container--default .select2-selection--single .select2-selection__rendered {
      line-height: 24px;
      color: #333;
    }
    .select2-container--default .select2-selection--single .select2-selection__arrow {
      height: 40px;
    }
    .select2-container--default .select2-selection--single:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
      outline: none;
    }
    .select2-container {
      width: 100% !important;
    }
    @media (max-width: 768px) {
      .container {
        padding: 15px;
      }
      .dashboard-btn {
        position: static;
        margin: 0 auto 15px;
        display: block;
        width: fit-content;
      }
      form {
        grid-template-columns: 1fr;
      }
      button.submit {
        max-width: 100%;
      }
      .tabs button {
        min-width: 120px;
        padding: 12px;
        font-size: 14px;
      }
      .search-container {
        flex-direction: column;
        gap: 10px;
      }
      .filter-group {
        width: 100%;
      }
      .filter-select {
        flex: 1;
      }
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="pageLoading">
    <div class="loading-spinner">
      <i class="fas fa-spinner fa-spin"></i> Loading...
    </div>
  </div>
  <div class="container">
    <a href="dashboard.html" class="dashboard-btn">
      <i class="fas fa-arrow-left"></i> Back to Dashboard
    </a>
    
    <div id="welcomeMessage" class="welcome-message" style="display: none;">
      Welcome, <span id="staffName"></span>!
    </div>

    <h2><i class="fas fa-home"></i> Smart Orphanage – Staff </h2>

    <div class="tabs">
      <button onclick="showSection('staff')"><i class="fas fa-users"></i> Staff Management</button>
      <button onclick="showSection('attendance')"><i class="fas fa-calendar-check"></i> Attendance</button>
      <button onclick="showSection('reports')"><i class="fas fa-chart-bar"></i> Reports</button>
      <button onclick="showSection('mistakeReports')"><i class="fas fa-exclamation-circle"></i> Mistake Reports</button>
    </div>

    <!-- Staff Management -->
    <div id="staff" class="section active">
      <div class="search-container">
        <input type="text" id="staffSearch" class="search-box" placeholder="Search staff by name, email or phone...">
        <div class="filter-group">
          <span class="filter-label">Filter by Job Title:</span>
          <select id="roleFilter" class="filter-select" onchange="filterStaffTable()">
            <option value="">All Job Titles</option>
            <option value="Caregiver">Caregiver</option>
            <option value="Teacher">Teacher</option>
            <option value="Administrator">Administrator</option>
            <option value="Cook">Cook</option>
            <option value="Driver">Driver</option>
            <option value="Other">Other</option>
          </select>
        </div>
      </div>

      <div class="bulk-actions" id="staffBulkActions">
        <button class="delete" onclick="deleteSelectedStaff()"><i class="fas fa-trash"></i> Delete Selected</button>
        <button class="edit" onclick="exportSelectedStaff()"><i class="fas fa-file-export"></i> Export Selected</button>
        <span id="selectedCount">0 selected</span>
      </div>

      <div class="form-container">
        <form id="staffForm">
          <input type="hidden" id="staffId">
          <div class="form-group">
            <label for="name">Full Name</label>
            <input type="text" id="name" placeholder="Enter full name" required pattern="[A-Za-z\s]{2,50}" title="Name should contain letters and spaces only, 2-50 characters" />
            <span class="error-message" id="nameError"></span>
          </div>
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" placeholder="Enter email" required />
            <span class="error-message" id="emailError"></span>
          </div>
          <div class="form-group">
            <label for="phone">Phone</label>
            <input type="text" id="phone" placeholder="Enter phone number" required pattern="[0-9]{10}" title="Phone number should be 10 digits" />
            <span class="error-message" id="phoneError"></span>
          </div>
          <div class="form-group">
            <label for="jobTitle">Job Title</label>
            <select id="jobTitle" required>
              <option value="">Select job title</option>
              <option value="Caregiver">Caregiver</option>
              <option value="Teacher">Teacher</option>
              <option value="Administrator">Administrator</option>
              <option value="Cook">Cook</option>
              <option value="Driver">Driver</option>
              <option value="Other">Other</option>
            </select>
            <span class="error-message" id="jobTitleError"></span>
          </div>
          <button class="submit" type="submit"><i class="fas fa-plus"></i> Add Staff</button>
        </form>
      </div>

      <div id="staffLoading" class="loading" style="display: none;">Loading staff...</div>
      <table>
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAllStaff" onchange="toggleSelectAllStaff()"></th>
            <th>Name</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Job Title</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="staffTableBody"></tbody>
      </table>
    </div>

    <!-- Attendance -->
    <div id="attendance" class="section">
      <div class="search-container">
        <input type="text" id="attendanceSearch" class="search-box" placeholder="Search attendance by staff name...">
        <div class="filter-group">
          <span class="filter-label">Filter by Status:</span>
          <select id="statusFilter" class="filter-select" onchange="filterAttendanceTable()">
            <option value="">All Statuses</option>
            <option value="Present">Present</option>
            <option value="Absent">Absent</option>
          </select>
        </div>
        <div class="filter-group">
          <span class="filter-label">Date Range:</span>
          <input type="date" id="startDate" class="filter-select" onchange="filterAttendanceTable()">
          <span>to</span>
          <input type="date" id="endDate" class="filter-select" onchange="filterAttendanceTable()">
        </div>
      </div>

      <div class="form-container">
        <form id="attendanceForm">
          <div class="form-group">
            <label for="attendanceStaff">Staff Member</label>
            <select id="attendanceStaff" class="select2" required>
              <option value="">Select staff member</option>
            </select>
            <span class="error-message" id="attendanceStaffError"></span>
          </div>
          <div class="form-group">
            <label for="attendanceStatus">Status</label>
            <select id="attendanceStatus" required>
              <option value="Present">Present</option>
              <option value="Absent">Absent</option>
            </select>
          </div>
          <div class="form-group">
            <label for="attendanceDate">Date</label>
            <input type="date" id="attendanceDate" required />
            <span class="error-message" id="attendanceDateError"></span>
          </div>
          <button class="submit" type="submit"><i class="fas fa-check-circle"></i> Mark Attendance</button>
        </form>
      </div>

      <div id="attendanceLoading" class="loading" style="display: none;">Loading attendance...</div>
      <table>
        <thead>
          <tr>
            <th>Staff</th>
            <th>Date</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="attendanceTableBody"></tbody>
      </table>
    </div>

    <!-- Reports -->
    <div id="reports" class="section">
      <div class="form-container">
        <form id="reportForm">
          <div class="form-group">
            <label for="reportType">Report Type</label>
            <select id="reportType" required onchange="updateReportOptions()">
              <option value="">Select report type</option>
              <option value="attendance_summary">Attendance Summary</option>
              <option value="staff_attendance">Staff Attendance</option>
              <option value="monthly_trends">Monthly Trends</option>
            </select>
          </div>
          
          <div id="reportOptions"></div>
          
          <button class="submit" type="button" onclick="generateReport()"><i class="fas fa-chart-pie"></i> Generate Report</button>
        </form>
      </div>
      
      <div id="reportResults" style="margin-top: 30px;"></div>
      
      <canvas id="reportCharts"></canvas>
    </div>

    <!-- Mistake Reports -->
    <div id="mistakeReports" class="section">
      <div class="search-container">
        <input type="text" id="reportSearch" class="search-box" placeholder="Search reports by staff name or date...">
        <div class="filter-group">
          <span class="filter-label">Filter by Status:</span>
          <select id="reportStatusFilter" class="filter-select" onchange="filterReportTable()">
            <option value="">All Statuses</option>
            <option value="Pending">Pending</option>
            <option value="Resolved">Resolved</option>
            <option value="Dismissed">Dismissed</option>
          </select>
        </div>
      </div>

      <div id="reportLoading" class="loading" style="display: none;">Loading reports...</div>
      <table>
        <thead>
          <tr>
            <th>Staff</th>
            <th>Date</th>
            <th>Reported Status</th>
            <th>Description</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="reportTableBody"></tbody>
      </table>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
  <script>
    const token = localStorage.getItem('token');
    const staffForm = document.getElementById('staffForm');
    const staffTableBody = document.getElementById('staffTableBody');
    const attendanceForm = document.getElementById('attendanceForm');
    const attendanceTableBody = document.getElementById('attendanceTableBody');
    const reportTableBody = document.getElementById('reportTableBody');
    let editingStaffId = null;
    let selectedStaff = [];
    let staffCache = [];

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('attendanceDate').value = today;

    $(document).ready(function() {
      $('#attendanceStaff, #reportStaff').select2({
        placeholder: "Select staff member",
        allowClear: true,
        width: '100%',
        dropdownCssClass: 'select2-dropdown'
      });
    });

    function sanitizeInput(input) {
      const div = document.createElement('div');
      div.textContent = input;
      return div.innerHTML;
    }

    function showLoading(elementId) {
      document.getElementById(elementId).style.display = 'block';
    }

    function hideLoading(elementId) {
      document.getElementById(elementId).style.display = 'none';
    }

    function showPageLoading() {
      document.getElementById('pageLoading').style.display = 'flex';
    }

    function hidePageLoading() {
      document.getElementById('pageLoading').style.display = 'none';
    }

    function showError(elementId, message) {
      const errorElement = document.getElementById(elementId);
      errorElement.textContent = message;
      errorElement.style.display = 'block';
    }

    function clearErrors(formId) {
      document.querySelectorAll(`#${formId} .error-message`).forEach(el => {
        el.textContent = '';
        el.style.display = 'none';
      });
    }

    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    function showSection(id) {
      document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
      document.getElementById(id).classList.add('active');
    }

    async function fetchCurrentStaff() {
      try {
        const response = await fetch('http://localhost:5001/api/staff/me', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch staff info');
        return await response.json();
      } catch (error) {
        console.error('Error fetching staff info:', error);
        return null;
      }
    }

    async function loadWelcomeMessage() {
      const staff = await fetchCurrentStaff();
      if (staff) {
        document.getElementById('staffName').textContent = sanitizeInput(staff.name);
        document.getElementById('welcomeMessage').style.display = 'block';
      }
    }

    async function fetchStaff() {
      if (staffCache.length > 0) return staffCache;
      showLoading('staffLoading');
      try {
        const response = await fetch('http://localhost:5001/api/staff', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch staff');
        staffCache = await response.json();
        return staffCache;
      } catch (error) {
        console.error('Error fetching staff:', error);
        return [];
      } finally {
        hideLoading('staffLoading');
      }
    }

    async function refreshStaffTable() {
      staffTableBody.innerHTML = '<tr><td colspan="6" class="no-data">Loading...</td></tr>';
      const staffList = await fetchStaff();
      const staffSelects = [$('#attendanceStaff'), $('#reportStaff')];

      staffSelects.forEach(select => {
        select.empty().append('<option value="">Select staff member</option>');
      });

      if (staffList.length === 0) {
        staffTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No staff members found. Please add staff members.</td></tr>';
        document.getElementById('staffBulkActions').style.display = 'none';
        return;
      }

      staffTableBody.innerHTML = '';
      staffList.forEach((s, index) => {
        staffTableBody.innerHTML += `
          <tr>
            <td><input type="checkbox" class="staff-checkbox" data-id="${s.id}"></td>
            <td>${sanitizeInput(s.name)}</td>
            <td>${sanitizeInput(s.email)}</td>
            <td>${sanitizeInput(s.phone)}</td>
            <td>${sanitizeInput(s.job_title)}</td>
            <td class="action-buttons">
              <button class="edit" onclick="editStaff('${s.id}')"><i class="fas fa-edit"></i> Edit</button>
              <button class="delete" onclick="deleteStaff('${s.id}')"><i class="fas fa-trash"></i> Delete</button>
            </td>
          </tr>
        `;
        
        staffSelects.forEach(select => {
          if (select) {
            select.append(`<option value="${s.id}">${sanitizeInput(s.name)} (${sanitizeInput(s.job_title)})</option>`);
          }
        });
      });

      document.querySelectorAll('.staff-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedStaff);
      });

      staffSelects.forEach(select => select.select2());
    }

    async function editStaff(id) {
      const staffList = await fetchStaff();
      const staff = staffList.find(s => s.id == id);
      if (staff) {
        document.getElementById('staffId').value = staff.id;
        document.getElementById('name').value = staff.name;
        document.getElementById('email').value = staff.email;
        document.getElementById('phone').value = staff.phone;
        document.getElementById('jobTitle').value = staff.job_title;
        editingStaffId = id;
        staffForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Staff';
        staffForm.scrollIntoView({ behavior: 'smooth' });
      }
    }

    async function deleteStaff(id) {
      if (confirm('Are you sure you want to delete this staff member?')) {
        try {
          console.log('Attempting to delete staff with ID:', id);
          const staffList = await fetchStaff();
          const staffExists = staffList.some(s => s.id === id);
          if (!staffExists) {
            throw new Error('Staff member not found in local cache. Please refresh the staff list.');
          }
          showLoading('staffLoading');
          const response = await fetch(`http://localhost:5001/api/staff/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) {
            let errorMessage = `Failed to delete staff: ${response.statusText} (${response.status})`;
            const contentType = response.headers.get('Content-Type');
            if (contentType && contentType.includes('application/json')) {
              const errorData = await response.json();
              errorMessage = `Failed to delete staff: ${errorData.message || response.statusText}`;
            }
            throw new Error(errorMessage);
          }
          staffCache = [];
          await refreshStaffTable();
          await loadAttendance();
          await loadMistakeReports();
          await updateDashboardCounts();
          alert('Staff deleted successfully');
        } catch (error) {
          console.error('Error deleting staff:', error);
          alert(error.message);
        } finally {
          hideLoading('staffLoading');
        }
      }
    }

    staffForm.onsubmit = async (e) => {
      e.preventDefault();
      clearErrors('staffForm');
      const name = document.getElementById('name').value.trim();
      const email = document.getElementById('email').value.trim();
      const phone = document.getElementById('phone').value.trim();
      const role = document.getElementById('jobTitle').value;

      let hasError = false;
      if (!name.match(/^[A-Za-z\s]{2,50}$/)) {
        showError('nameError', 'Name should contain letters and spaces only, 2-50 characters');
        hasError = true;
      }
      if (!email.match(/^[\w-\.]+@([\w-]+\.)+[\w-]{2,4}$/)) {
        showError('emailError', 'Invalid email format');
        hasError = true;
      }
      if (!phone.match(/^[0-9]{10}$/)) {
        showError('phoneError', 'Phone number should be 10 digits');
        hasError = true;
      }
      if (!role) {
        showError('jobTitleError', 'Please select a job title');
        hasError = true;
      }

      if (hasError) return;

      const staff = { name: sanitizeInput(name), email, phone, role };

      try {
        showLoading('staffLoading');
        const url = editingStaffId ? `http://localhost:5001/api/staff/${editingStaffId}` : 'http://localhost:5001/api/staff';
        const method = editingStaffId ? 'PUT' : 'POST';
        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(staff)
        });
        if (!response.ok) throw new Error('Failed to save staff');
        staffForm.reset();
        document.getElementById('staffId').value = '';
        editingStaffId = null;
        staffForm.querySelector('button[type="submit"]').innerHTML = '<i class="fas fa-plus"></i> Add Staff';
        staffCache = [];
        await refreshStaffTable();
        await loadAttendance();
        await loadMistakeReports();
        await updateDashboardCounts();
      } catch (error) {
        console.error('Error saving staff:', error);
        alert('Failed to save staff');
      } finally {
        hideLoading('staffLoading');
      }
    };

    function filterStaffTable() {
      const searchTerm = document.getElementById('staffSearch').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const rows = staffTableBody.querySelectorAll('tr');

      rows.forEach(row => {
        if (row.classList.contains('no-data')) return;
        const name = row.cells[1].textContent.toLowerCase();
        const email = row.cells[2].textContent.toLowerCase();
        const phone = row.cells[3].textContent.toLowerCase();
        const role = row.cells[4].textContent;
        const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm) || phone.includes(searchTerm);
        const matchesRole = !roleFilter || role === roleFilter;
        row.style.display = (matchesSearch && matchesRole) ? '' : 'none';
      });
    }

    function toggleSelectAllStaff() {
      const checkboxes = document.querySelectorAll('.staff-checkbox');
      const selectAll = document.getElementById('selectAllStaff').checked;
      checkboxes.forEach(checkbox => checkbox.checked = selectAll);
      updateSelectedStaff();
    }

    function updateSelectedStaff() {
      const checkboxes = document.querySelectorAll('.staff-checkbox:checked');
      selectedStaff = Array.from(checkboxes).map(cb => cb.dataset.id);
      const bulkActions = document.getElementById('staffBulkActions');
      bulkActions.style.display = selectedStaff.length > 0 ? 'block' : 'none';
      document.getElementById('selectedCount').textContent = `${selectedStaff.length} selected`;
      document.getElementById('selectAllStaff').checked = selectedStaff.length > 0 && selectedStaff.length === document.querySelectorAll('.staff-checkbox').length;
    }

    async function deleteSelectedStaff() {
      if (selectedStaff.length === 0 || !confirm(`Are you sure you want to delete ${selectedStaff.length} staff members?`)) return;
      try {
        showLoading('staffLoading');
        for (const id of selectedStaff) {
          const response = await fetch(`http://localhost:5001/api/staff/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) {
            let errorMessage = `Failed to delete staff ${id}: ${response.statusText} (${response.status})`;
            const contentType = response.headers.get('Content-Type');
            if (contentType && contentType.includes('application/json')) {
              const errorData = await response.json();
              errorMessage = `Failed to delete staff ${id}: ${errorData.message || response.statusText}`;
            }
            throw new Error(errorMessage);
          }
        }
        staffCache = [];
        await refreshStaffTable();
        await loadAttendance();
        await loadMistakeReports();
        await updateDashboardCounts();
        selectedStaff = [];
        document.getElementById('staffBulkActions').style.display = 'none';
        alert('Selected staff deleted successfully');
      } catch (error) {
        console.error('Error deleting selected staff:', error);
        alert(error.message);
      } finally {
        hideLoading('staffLoading');
      }
    }

    function exportSelectedStaff() {
      if (selectedStaff.length === 0) return;
      const selectedData = staffCache.filter(s => selectedStaff.includes(s.id));
      let csv = 'Name,Email,Phone,Job Title\n';
      selectedData.forEach(staff => {
        csv += `"${sanitizeInput(staff.name)}","${sanitizeInput(staff.email)}","${sanitizeInput(staff.phone)}","${sanitizeInput(staff.role)}"\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `staff_export_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    attendanceForm.onsubmit = async (e) => {
      e.preventDefault();
      clearErrors('attendanceForm');
      const staffId = $('#attendanceStaff').val();
      const date = document.getElementById('attendanceDate').value;
      const status = document.getElementById('attendanceStatus').value;

      let hasError = false;
      if (!staffId) {
        showError('attendanceStaffError', 'Please select a staff member');
        hasError = true;
      }
      if (!date) {
        showError('attendanceDateError', 'Please select a date');
        hasError = true;
      }

      if (hasError) return;

      const entry = { staff_id: staffId, date, status };

      try {
        showLoading('attendanceLoading');
        const response = await fetch('http://localhost:5001/api/attendance', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify(entry)
        });
        if (!response.ok) throw new Error('Failed to record attendance');
        attendanceForm.reset();
        document.getElementById('attendanceDate').value = today;
        $('#attendanceStaff').val('').trigger('change');
        await loadAttendance();
        await loadMistakeReports();
      } catch (error) {
        console.error('Error recording attendance:', error);
        alert('Failed to record attendance');
      } finally {
        hideLoading('attendanceLoading');
      }
    };

    async function loadAttendance() {
      showLoading('attendanceLoading');
      try {
        const response = await fetch('http://localhost:5001/api/attendance', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to fetch attendance');
        const list = await response.json();
        const staffList = await fetchStaff();
        attendanceTableBody.innerHTML = '';

        if (list.length === 0) {
          attendanceTableBody.innerHTML = '<tr><td colspan="4" class="no-data">No attendance records found.</td></tr>';
          return;
        }

        list.sort((a, b) => new Date(b.date) - new Date(a.date));
        list.forEach(a => {
          const staff = staffList.find(s => s.id === a.staff_id);
          const statusClass = a.status === 'Present' ? 'status-present' : 'status-absent';
          attendanceTableBody.innerHTML += `
            <tr>
              <td>${staff ? sanitizeInput(staff.name) : 'Unknown'}</td>
              <td data-date="${a.date}">${formatDate(a.date)}</td>
              <td class="${statusClass}">${sanitizeInput(a.status)}</td>
              <td class="action-buttons">
                <button class="delete" onclick="deleteAttendanceRecord('${a.id}')"><i class="fas fa-trash"></i> Delete</button>
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('Error loading attendance:', error);
        attendanceTableBody.innerHTML = '<tr><td colspan="4" class="no-data">Error loading attendance records.</td></tr>';
      } finally {
        hideLoading('attendanceLoading');
      }
    }

    async function deleteAttendanceRecord(id) {
      if (confirm('Are you sure you want to delete this attendance record?')) {
        try {
          showLoading('attendanceLoading');
          const response = await fetch(`http://localhost:5001/api/attendance/${id}`, {
            method: 'DELETE',
            headers: { 'Authorization': `Bearer ${token}` }
          });
          if (!response.ok) throw new Error('Failed to delete attendance record');
          await loadAttendance();
          await loadMistakeReports();
        } catch (error) {
          console.error('Error deleting attendance:', error);
          alert('Failed to delete attendance record');
        } finally {
          hideLoading('attendanceLoading');
        }
      }
    }

    function filterAttendanceTable() {
      const searchTerm = document.getElementById('attendanceSearch').value.toLowerCase();
      const statusFilter = document.getElementById('statusFilter').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const rows = attendanceTableBody.querySelectorAll('tr');

      rows.forEach(row => {
        if (row.classList.contains('no-data')) return;
        const staff = row.cells[0].textContent.toLowerCase();
        const date = new Date(row.cells[1].getAttribute('data-date'));
        const status = row.cells[2].textContent;
        const matchesSearch = staff.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        const matchesDate = (!startDate || date >= new Date(startDate)) && (!endDate || date <= new Date(endDate));
        row.style.display = (matchesSearch && matchesStatus && matchesDate) ? '' : 'none';
      });
    }

    function filterReportTable() {
      const searchTerm = document.getElementById('reportSearch').value.toLowerCase();
      const statusFilter = document.getElementById('reportStatusFilter').value;
      const rows = reportTableBody.querySelectorAll('tr');

      rows.forEach(row => {
        if (row.classList.contains('no-data')) return;
        const staff = row.cells[0].textContent.toLowerCase();
        const date = row.cells[1].textContent.toLowerCase();
        const status = row.cells[4].textContent;
        const matchesSearch = staff.includes(searchTerm) || date.includes(searchTerm);
        const matchesStatus = !statusFilter || status === statusFilter;
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
      });
    }

    async function loadMistakeReports() {
      showLoading('reportLoading');
      console.log("_________________________reportMIatake____________________ ");
      try {
        const response = await fetch('http://localhost:5001/api/staff/attendance/complaints', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
         
        if (!response.ok) throw new Error('Failed to fetch mistake reports');
        const reports = await response.json();
        const staffList = await fetchStaff();
        reportTableBody.innerHTML = '';
        console.log(reports);
        console.log(staffList);
        if (reports.length === 0) {
          reportTableBody.innerHTML = '<tr><td colspan="6" class="no-data">No mistake reports found.</td></tr>';
          return;
        }

        reports.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
        reports.forEach(r => {
          const staff = staffList.find(s => s.id === r.a_staff_id);
          const statusClass = r.status === 'Pending' ? 'status-pending' : r.status === 'Resolved' ? 'status-resolved' : 'status-dismissed';
          reportTableBody.innerHTML += `
            <tr>
              <td>${staff ? sanitizeInput(staff.name) : 'Unknown'}</td>
              <td data-date="${r.attendance_date}">${formatDate(r.attendance_date)}</td>
              <td class="${r.attendance_status === 'Present' ? 'status-present' : 'status-absent'}">${sanitizeInput(r.attendance_status)}</td>
              <td>${sanitizeInput(r.description)}</td>
              <td class="${statusClass}">${sanitizeInput(r.status)}</td>
              <td class="action-buttons">
                ${r.status === 'Pending' ? `
                  <button class="resolve" onclick="resolveReport('${r.id}', 'Resolved')"><i class="fas fa-check"></i> Resolve</button>
                  <button class="delete" onclick="resolveReport('${r.id}', 'Dismissed')"><i class="fas fa-times"></i> Dismiss</button>
                ` : ''}
              </td>
            </tr>
          `;
        });
      } catch (error) {
        console.error('Error loading mistake reports:', error);
        reportTableBody.innerHTML = '<tr><td colspan="6" class="no-data">Error loading mistake reports.</td></tr>';
      } finally {
        hideLoading('reportLoading');
      }
    }

    async function resolveReport(id, status) {
      if (confirm(`Are you sure you want to ${status.toLowerCase()} this mistake report?`)) {
        try {
          showLoading('reportLoading');
          const response = await fetch(`http://localhost:5001/api/staff/attendance/complaints/${id}`, {
            method: 'PUT',
            headers: {
              'Content-Type': 'application/json',
              'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ status })
          });
          if (!response.ok) throw new Error(`Failed to ${status.toLowerCase()} report`);
          await loadMistakeReports();
        } catch (error) {
          console.error(`Error ${status.toLowerCase()} report:`, error);
          alert(`Failed to ${status.toLowerCase()} report`);
        } finally {
          hideLoading('reportLoading');
        }
      }
    }

    let attendanceChart = null;

    function updateReportOptions() {
      const reportType = document.getElementById('reportType').value;
      const optionsContainer = document.getElementById('reportOptions');
      optionsContainer.innerHTML = '';

      if (!reportType) return;

      switch(reportType) {
        case 'attendance_summary':
          optionsContainer.innerHTML = `
            <div class="form-group">
              <label for="summaryDateRange">Date Range</label>
              <select id="summaryDateRange" required>
                <option value="last_7">Last 7 Days</option>
                <option value="last_30">Last 30 Days</option>
                <option value="this_month">This Month</option>
                <option value="last_month">Last Month</option>
                <option value="custom">Custom Range</option>
              </select>
            </div>
            <div class="form-group" id="customRangeGroup" style="display: none;">
              <label>Custom Range</label>
              <div style="display: flex; gap: 10px;">
                <input type="date" id="customStartDate">
                <span>to</span>
                <input type="date" id="customEndDate">
              </div>
            </div>
          `;
          document.getElementById('summaryDateRange').addEventListener('change', function() {
            document.getElementById('customRangeGroup').style.display = this.value === 'custom' ? 'block' : 'none';
          });
          break;

        case 'staff_attendance':
          optionsContainer.innerHTML = `
            <div class="form-group">
              <label for="reportStaff">Staff Member</label>
              <select id="reportStaff" class="select2" required>
                <option value="">Select staff member</option>
              </select>
            </div>
            <div class="form-group">
              <label for="staffReportPeriod">Period</label>
              <select id="staffReportPeriod" required>
                <option value="last_7">Last 7 Days</option>
                <option value="last_30">Last 30 Days</option>
                <option value="this_month">This Month</option>
                <option value="last_3_months">Last 3 Months</option>
              </select>
            </div>
          `;
          fetchStaff().then(staffList => {
            const staffSelect = $('#reportStaff');
            staffSelect.empty().append('<option value="">Select staff member</option>');
            staffList.forEach(staff => {
              staffSelect.append(`<option value="${staff.id}">${sanitizeInput(staff.name)} (${sanitizeInput(staff.role)})</option>`);
            });
            staffSelect.select2();
          });
          break;

        case 'monthly_trends':
          optionsContainer.innerHTML = `
            <div class="form-group">
              <label for="trendsMonths">Number of Months</label>
              <select id="trendsMonths" required>
                <option value="3">3 Months</option>
                <option value="6">6 Months</option>
                <option value="12">12 Months</option>
              </select>
            </div>
          `;
          break;
      }
    }

    async function generateReport() {
      const reportType = document.getElementById('reportType').value;
      if (!reportType) return;

      const resultsContainer = document.getElementById('reportResults');
      resultsContainer.innerHTML = '<p>Generating report...</p>';

      if (attendanceChart) attendanceChart.destroy();

      switch(reportType) {
        case 'attendance_summary':
          await generateAttendanceSummary();
          break;
        case 'staff_attendance':
          await generateStaffAttendanceReport();
          break;
        case 'monthly_trends':
          await generateMonthlyTrends();
          break;
      }
    }

    async function generateAttendanceSummary() {
      const dateRange = document.getElementById('summaryDateRange').value;
      let startDate, endDate = new Date();

      switch(dateRange) {
        case 'last_7': startDate = new Date(); startDate.setDate(endDate.getDate() - 7); break;
        case 'last_30': startDate = new Date(); startDate.setDate(endDate.getDate() - 30); break;
        case 'this_month': startDate = new Date(); startDate.setDate(1); break;
        case 'last_month':
          endDate = new Date(); endDate.setMonth(endDate.getMonth() - 1);
          endDate.setDate(0); startDate = new Date(endDate); startDate.setDate(1); break;
        case 'custom':
          startDate = new Date(document.getElementById('customStartDate').value);
          endDate = new Date(document.getElementById('customEndDate').value);
          break;
      }

      try {
        const response = await fetch('http://localhost:5001/api/attendance', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const attendanceData = await response.json();
        const filteredData = attendanceData.filter(a => {
          const date = new Date(a.date);
          return date >= startDate && date <= endDate;
        });

        const presentCount = filteredData.filter(a => a.status === 'Present').length;
        const absentCount = filteredData.filter(a => a.status === 'Absent').length;
        const total = presentCount + absentCount;
        const attendanceRate = total > 0 ? Math.round((presentCount / total) * 100) : 0;

        document.getElementById('reportResults').innerHTML = `
          <h3>Attendance Summary (${formatDate(startDate)} to ${formatDate(endDate)})</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${total}</div>
              <div style="color: #7f8c8d;">Total Records</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${presentCount}</div>
              <div style="color: #7f8c8d;">Present</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${absentCount}</div>
              <div style="color: #7f8c8d;">Absent</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #3498db;">${attendanceRate}%</div>
              <div style="color: #7f8c8d;">Attendance Rate</div>
            </div>
          </div>
        `;

        const ctx = document.getElementById('reportCharts').getContext('2d');
        attendanceChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Present', 'Absent'],
            datasets: [{
              data: [presentCount, absentCount],
              backgroundColor: ['#2ecc71', '#e74c3c'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            plugins: {
              legend: { position: 'top' },
              title: { display: true, text: 'Attendance Distribution' }
            }
          }
        });
      } catch (error) {
        console.error('Error generating attendance summary:', error);
        document.getElementById('reportResults').innerHTML = '<p>Error generating report.</p>';
      }
    }

    async function generateStaffAttendanceReport() {
      const staffId = $('#reportStaff').val();
      const period = document.getElementById('staffReportPeriod').value;
      if (!staffId) {
        alert('Please select a staff member');
        return;
      }

      let startDate, endDate = new Date();
      switch(period) {
        case 'last_7': startDate = new Date(); startDate.setDate(endDate.getDate() - 7); break;
        case 'last_30': startDate = new Date(); startDate.setDate(endDate.getDate() - 30); break;
        case 'this_month': startDate = new Date(); startDate.setDate(1); break;
        case 'last_3_months': startDate = new Date(); startDate.setMonth(endDate.getMonth() - 3); break;
      }

      try {
        const [attendanceResponse, staffResponse] = await Promise.all([
          fetch('http://localhost:5001/api/attendance', { headers: { 'Authorization': `Bearer ${token}` } }),
          fetch('http://localhost:5001/api/staff', { headers: { 'Authorization': `Bearer ${token}` } })
        ]);
        const attendanceData = await attendanceResponse.json();
        const staffList = await staffResponse.json();
        const staff = staffList.find(s => s.id === staffId);
        const filteredData = attendanceData.filter(a => a.staff_id === staffId && new Date(a.date) >= startDate && new Date(a.date) <= endDate);

        const presentCount = filteredData.filter(a => a.status === 'Present').length;
        const absentCount = filteredData.filter(a => a.status === 'Absent').length;
        const total = presentCount + absentCount;
        const attendanceRate = total > 0 ? Math.round((presentCount / total) * 100) : 0;

        document.getElementById('reportResults').innerHTML = `
          <h3>Attendance Report for ${sanitizeInput(staff ? staff.name : 'Unknown')}</h3>
          <p>Period: ${formatDate(startDate)} to ${formatDate(endDate)}</p>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2c3e50;">${total}</div>
              <div style="color: #7f8c8d;">Total Days</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #2ecc71;">${presentCount}</div>
              <div style="color: #7f8c8d;">Present</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #e74c3c;">${absentCount}</div>
              <div style="color: #7f8c8d;">Absent</div>
            </div>
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; text-align: center;">
              <div style="font-size: 24px; font-weight: bold; color: #3498db;">${attendanceRate}%</div>
              <div style="color: #7f8c8d;">Attendance Rate</div>
            </div>
          </div>
          <h4 style="margin-top: 30px;">Recent Attendance</h4>
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody>
              ${filteredData.slice(0, 10).map(a => `
                <tr>
                  <td>${formatDate(a.date)}</td>
                  <td class="${a.status === 'Present' ? 'status-present' : 'status-absent'}">${sanitizeInput(a.status)}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
        `;

        const ctx = document.getElementById('reportCharts').getContext('2d');
        attendanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ['Present', 'Absent'],
            datasets: [{
              label: 'Attendance Count',
              data: [presentCount, absentCount],
              backgroundColor: ['#2ecc71', '#e74c3c'],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            scales: { y: { beginAtZero: true } },
            plugins: {
              legend: { display: false },
              title: { display: true, text: `${sanitizeInput(staff ? staff.name : 'Unknown')}'s Attendance` }
            }
          }
        });
      } catch (error) {
        console.error('Error generating staff attendance report:', error);
        document.getElementById('reportResults').innerHTML = '<p>Error generating report.</p>';
      }
    }

    async function generateMonthlyTrends() {
      const monthsCount = parseInt(document.getElementById('trendsMonths').value);
      const endDate = new Date();
      const startDate = new Date();
      startDate.setMonth(endDate.getMonth() - monthsCount);

      try {
        const response = await fetch('http://localhost:5001/api/attendance', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        const attendanceData = await response.json();
        const filteredData = attendanceData.filter(a => {
          const date = new Date(a.date);
          return date >= startDate && date <= endDate;
        });

        const monthlyData = {};
        const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

        for (let i = 0; i < monthsCount; i++) {
          const date = new Date();
          date.setMonth(date.getMonth() - i);
          const year = date.getFullYear();
          const month = date.getMonth();
          const key = `${year}-${month}`;
          monthlyData[key] = { present: 0, absent: 0, label: `${monthNames[month]} ${year}` };
        }

        filteredData.forEach(a => {
          const date = new Date(a.date);
          const year = date.getFullYear();
          const month = date.getMonth();
          const key = `${year}-${month}`;
          if (monthlyData[key]) {
            if (a.status === 'Present') monthlyData[key].present++;
            else monthlyData[key].absent++;
          }
        });

        const labels = Object.values(monthlyData).reverse().map(m => m.label);
        const presentData = Object.values(monthlyData).reverse().map(m => m.present);
        const absentData = Object.values(monthlyData).reverse().map(m => m.absent);

        document.getElementById('reportResults').innerHTML = `
          <h3>Monthly Attendance Trends (Last ${monthsCount} Months)</h3>
          <table>
            <thead>
              <tr>
                <th>Month</th>
                <th>Present</th>
                <th>Absent</th>
                <th>Attendance Rate</th>
              </tr>
            </thead>
            <tbody>
              ${Object.entries(monthlyData).reverse().map(([key, data]) => {
                const total = data.present + data.absent;
                const rate = total > 0 ? Math.round((data.present / total) * 100) : 0;
                return `
                  <tr>
                    <td>${data.label}</td>
                    <td>${data.present}</td>
                    <td>${data.absent}</td>
                    <td>${rate}%</td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        `;

        const ctx = document.getElementById('reportCharts').getContext('2d');
        attendanceChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: labels,
            datasets: [
              {
                label: 'Present',
                data: presentData,
                borderColor: '#2ecc71',
                backgroundColor: 'rgba(46, 204, 113, 0.1)',
                tension: 0.3,
                fill: true
              },
              {
                label: 'Absent',
                data: absentData,
                borderColor: '#e74c3c',
                backgroundColor: 'rgba(231, 76, 60, 0.1)',
                tension: 0.3,
                fill: true
              }
            ]
          },
          options: {
            responsive: true,
            interaction: { mode: 'index', intersect: false },
            scales: { y: { beginAtZero: true } },
            plugins: { title: { display: true, text: 'Monthly Attendance Trends' } }
          }
        });
      } catch (error) {
        console.error('Error generating monthly trends:', error);
        document.getElementById('reportResults').innerHTML = '<p>Error generating report.</p>';
      }
    }

    document.getElementById('staffSearch').addEventListener('input', filterStaffTable);
    document.getElementById('roleFilter').addEventListener('change', filterStaffTable);
    document.getElementById('attendanceSearch').addEventListener('input', filterAttendanceTable);
    document.getElementById('statusFilter').addEventListener('change', filterAttendanceTable);
    document.getElementById('startDate').addEventListener('change', filterAttendanceTable);
    document.getElementById('endDate').addEventListener('change', filterAttendanceTable);
    document.getElementById('reportSearch').addEventListener('input', filterReportTable);
    document.getElementById('reportStatusFilter').addEventListener('change', filterReportTable);

    async function updateDashboardCounts() {
      try {
        const response = await fetch('http://localhost:5001/api/dashboard/counts', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) throw new Error('Failed to update dashboard counts');
      } catch (error) {
        console.error('Error updating dashboard counts:', error);
      }
    }

    async function validateToken() {
      try {
        const response = await fetch('http://localhost:5001/api/auth/validate', {
          headers: { 'Authorization': `Bearer ${token}` }
        });
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Invalid token');
        }
        return true;
      } catch (error) {
        console.error('Token validation failed:', error);
        return false;
      }
    }

    window.onload = async () => {
      if (!token) {
        window.location.href = 'login.html?reason=no_token';
        return;
      }

      showPageLoading();

      const isValid = await validateToken();
      if (!isValid) {
        localStorage.removeItem('token');
        alert('Invalid session. Please log in again.');
        window.location.href = 'login.html?reason=invalid';
        return;
      }

      try {
        await Promise.all([
          loadWelcomeMessage(),
          refreshStaffTable(),
          loadAttendance(),
          loadMistakeReports(),
          updateReportOptions()
        ]);
      } catch (error) {
        console.error('Error initializing dashboard:', error);
        alert('Failed to load dashboard. Please try again.');
      } finally {
        hidePageLoading();
      }
    };
  </script>
</body>
</html>