<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Smart Orphanage - Reports Management</title>
  <style>
    body { 
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
      background: #f5f7fa; 
      padding: 20px; 
      margin: 0;
      color: #333;
    }
    .container { 
      max-width: 1000px; 
      margin: auto; 
      background: white; 
      padding: 25px; 
      border-radius: 10px; 
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: relative;
    }
    h2 { 
      text-align: center; 
      color: #2c3e50;
      margin-bottom: 25px;
      padding-bottom: 10px;
      border-bottom: 2px solid #3498db;
    }
    .form-container {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 25px;
    }
    form { 
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
      margin-bottom: 0;
    }
    .form-group {
      display: flex;
      flex-direction: column;
    }
    label {
      margin-bottom: 8px;
      font-weight: 500;
      font-size: 14px;
    }
    input, select, textarea { 
      padding: 12px; 
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 15px;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      outline: none;
      box-shadow: 0 0 0 3px rgba(52,152,219,0.2);
    }
    button { 
      padding: 12px 20px; 
      cursor: pointer; 
      border: none;
      border-radius: 6px;
      font-weight: 600;
      transition: all 0.3s;
    }
    button[type="submit"] {
      background: #2ecc71;
      color: white;
      grid-column: 1 / -1;
      max-width: 200px;
    }
    button[type="submit"]:hover {
      background: #27ae60;
      transform: translateY(-2px);
    }
    table { 
      width: 100%; 
      border-collapse: collapse;
      margin-top: 20px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    th, td { 
      padding: 12px 15px; 
      border: 1px solid #e0e0e0; 
      text-align: left; 
    }
    th { 
      background: #3498db;
      color: white;
      font-weight: 600;
      position: sticky;
      top: 0;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
    .action-btns {
      display: flex;
      gap: 8px;
    }
    .delete-btn { 
      background: #e74c3c; 
      color: white; 
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .delete-btn:hover {
      background: #c0392b;
      transform: translateY(-1px);
    }
    .edit-btn {
      background: #f39c12;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .edit-btn:hover {
      background: #d35400;
      transform: translateY(-1px);
    }
    .download-btn {
      background: #3498db;
      color: white;
      padding: 6px 12px;
      border-radius: 4px;
      font-size: 14px;
    }
    .download-btn:hover {
      background: #2980b9;
      transform: translateY(-1px);
    }
    .search-container {
      margin-bottom: 20px;
      display: flex;
      gap: 10px;
    }
    .search-container input {
      flex: 1;
      padding: 10px;
    }
    .no-reports {
      text-align: center;
      padding: 30px;
      color: #7f8c8d;
      font-style: italic;
    }
    .report-category {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
    }
    .category-inventory {
      background: #e3f2fd;
      color: #1976d2;
    }
    .category-attendance {
      background: #e8f5e9;
      color: #388e3c;
    }
    .category-donations {
      background: #f3e5f5;
      color: #8e24aa;
    }
    .category-general {
      background: #fff3e0;
      color: #e65100;
    }
    .category-events {
      background: #e1f5fe;
      color: #0277bd;
    }
    .category-financial {
      background: #f1f8e9;
      color: #558b2f;
    }
    .dashboard-btn {
      position: absolute;
      top: 20px;
      right: 20px;
      background: #9b59b6;
      color: white;
      padding: 8px 16px;
      border-radius: 6px;
      text-decoration: none;
      font-weight: 500;
      transition: all 0.3s;
    }
    .dashboard-btn:hover {
      background: #8e44ad;
      transform: translateY(-2px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    @media (max-width: 768px) {
      form {
        grid-template-columns: 1fr;
      }
      button[type="submit"] {
        max-width: 100%;
      }
      .dashboard-btn {
        position: static;
        margin-bottom: 15px;
        display: inline-block;
      }
    }
  </style>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
  <div class="container">
    <!-- Modal for viewing report details -->
<div id="reportModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center;">
  <div style="background: white; padding: 20px; border-radius: 8px; max-width: 500px; width: 90%; position: relative;">
    <button onclick="closeModal()" style="position: absolute; top: 10px; right: 10px; background: #e74c3c; color: white; border: none; border-radius: 4px; padding: 5px 10px; cursor: pointer;">&times;</button>
    <h3>Report Details</h3>
    <pre id="reportDetails" style="white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;"></pre>
  </div>
</div>
    <a href="dashboard.html" class="dashboard-btn"><i class="fas fa-arrow-left"></i> Back to Dashboard</a>
    <h2>Smart Orphanage - Reports Management</h2>

    <div class="search-container">
      <input type="text" id="searchInput" placeholder="Search reports..." oninput="filterReports()">
      <button onclick="generateSummaryReport()">Generate Summary</button>
    </div>

    <div class="form-container">
      <form id="reportForm">
        <input type="hidden" id="reportId">
        <div class="form-group">
          <label for="title">Report Title</label>
          <input type="text" id="title" placeholder="e.g. Monthly Inventory Report" required />
        </div>
        <div class="form-group">
          <label for="category">Category</label>
          <select id="category" required>
            <option value="">Select category</option>
            <option value="Inventory">Inventory</option>
            <option value="Attendance">Attendance</option>
            <option value="Donations">Donations</option>
            <option value="Events">Events</option>
            <option value="Financial">Financial</option>
            <option value="General">General</option>
          </select>
        </div>
        <div class="form-group">
          <label for="date">Report Date</label>
          <input type="date" id="date" required />
        </div>
        <div class="form-group">
          <label for="notes">Summary / Notes</label>
          <textarea id="notes" placeholder="Detailed report content" required></textarea>
        </div>
        <div class="form-group">
          <label for="author">Prepared By</label>
          <input type="text" id="author" placeholder="Report author" required />
        </div>
        <button type="submit" id="submitBtn">Submit Report</button>
      </form>
    </div>

    <table>
      <thead>
        <tr>
          <th>Title</th>
          <th>Category</th>
          <th>Date</th>
          <th>Author</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="reportTable"></tbody>
    </table>
  </div>

  <script>
    // Get JWT token from localStorage
    function getToken() {
      return localStorage.getItem('token');
    }

    // Helper function for authenticated fetch requests
    async function fetchWithAuth(url, options = {}) {
      const response = await fetch(url, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${getToken()}`,
          ...options.headers
        }
      });
      if (response.status === 401) {
        alert('Session expired. Please log in again.');
        window.location.href = 'login.html';
      }
      return response;
    }

    // Load reports into table
    async function loadReports(searchTerm = '') {
      const tbody = document.getElementById('reportTable');
      tbody.innerHTML = '';

      try {
        const url = searchTerm ? `/api/reports?search=${encodeURIComponent(searchTerm)}` : '/api/reports';
        const response = await fetchWithAuth(url);
        const reports = await response.json();

        if (reports.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="no-reports">No reports found. Create some reports to get started.</td></tr>';
          return;
        }

        // Sort by date (newest first)
        reports.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        reports.forEach(report => {
          const categoryClass = report.category === "Inventory" ? "category-inventory" : 
                              report.category === "Attendance" ? "category-attendance" :
                              report.category === "Donations" ? "category-donations" :
                              report.category === "Events" ? "category-events" :
                              report.category === "Financial" ? "category-financial" : 
                              "category-general";
          
          tbody.innerHTML += `
            <tr>
              <td>${report.title}</td>
              <td><span class="report-category ${categoryClass}">${report.category}</span></td>
              <td>${formatDate(report.date)}</td>
              <td>${report.author}</td>
              <td class="action-btns">
                <button class="edit-btn" onclick="editReport('${report.id}')">Edit</button>
                <button class="download-btn" onclick="viewReport('${report.id}')">View</button>
                <button class="delete-btn" onclick="deleteReport('${report.id}')">Delete</button>
              </td>
            </tr>`;
        });
      } catch (err) {
        console.error(err);
        tbody.innerHTML = '<tr><td colspan="5" class="no-reports">Failed to load reports. Please try again.</td></tr>';
      }
    }

    // Filter reports based on search input
    function filterReports() {
      const searchTerm = document.getElementById('searchInput').value.trim();
      loadReports(searchTerm);
    }

    // Add or update report
    document.getElementById('reportForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = document.getElementById('reportId').value;
      const reportData = {
        title: document.getElementById('title').value,
        category: document.getElementById('category').value,
        date: document.getElementById('date').value,
        notes: document.getElementById('notes').value,
        author: document.getElementById('author').value
      };
      
      try {
        let response;
        if (id) {
          // Update existing report
          response = await fetchWithAuth(`/api/reports/${id}`, {
            method: 'PUT',
            body: JSON.stringify(reportData)
          });
        } else {
          // Add new report
          response = await fetchWithAuth('/api/reports', {
            method: 'POST',
            body: JSON.stringify(reportData)
          });
        }
        
        const result = await response.json();
        if (response.ok) {
          alert(id ? '✅ Report updated successfully!' : '✅ Report added successfully!');
          document.getElementById('reportForm').reset();
          document.getElementById('reportId').value = '';
          document.getElementById('date').value = new Date().toISOString().split('T')[0];
          document.getElementById('submitBtn').textContent = 'Submit Report';
          loadReports();
        } else {
          alert(`❌ Error: ${result.message}`);
        }
      } catch (err) {
        alert('❌ Failed to save report. Please try again.');
        console.error(err);
      }
    });

    // Edit report
    async function editReport(id) {
      try {
        const response = await fetchWithAuth(`/api/reports/${id}`);
        const report = await response.json();
        
        if (response.ok && report) {
          document.getElementById('reportId').value = report.id;
          document.getElementById('title').value = report.title;
          document.getElementById('category').value = report.category;
          document.getElementById('date').value = report.date;
          document.getElementById('notes').value = report.notes;
          document.getElementById('author').value = report.author;
          document.getElementById('submitBtn').textContent = 'Update Report';
          
          // Scroll to form
          document.getElementById('reportForm').scrollIntoView({ behavior: 'smooth' });
        } else {
          alert('❌ Failed to load report details.');
        }
      } catch (err) {
        alert('❌ Failed to load report details. Please try again.');
        console.error(err);
      }
    }

    // View report details
    async function viewReport(id) {
      try {
        const response = await fetchWithAuth(`/api/reports/${id}`);
        const report = await response.json();
        
        if (response.ok && report) {
          const reportDetails = `
            Report Title: ${report.title}
            Category: ${report.category}
            Date: ${formatDate(report.date)}
            Author: ${report.author}
            
            Notes:
            ${report.notes}
          `;
          alert(reportDetails);
        } else {
          alert('❌ Failed to load report details.');
        }
      } catch (err) {
        alert('❌ Failed to load report details. Please try again.');
        console.error(err);
      }
    }

    // Generate summary report
    async function generateSummaryReport() {
      try {
        const response = await fetchWithAuth('/api/reports/summary');
        const result = await response.json();
        if (response.ok) {
          alert(result.summary);
        } else {
          alert(`❌ Error: ${result.message}`);
        }
      } catch (err) {
        alert('❌ Failed to generate summary report. Please try again.');
        console.error(err);
      }
    }

    // Delete report
    async function deleteReport(id) {
      if (confirm('Are you sure you want to delete this report?')) {
        try {
          const response = await fetchWithAuth(`/api/reports/${id}`, {
            method: 'DELETE'
          });
          const result = await response.json();
          if (response.ok) {
            alert('✅ Report deleted successfully!');
            loadReports();
          } else {
            alert(`❌ Error: ${result.message}`);
          }
        } catch (err) {
          alert('❌ Failed to delete report. Please try again.');
          console.error(err);
        }
      }
    }

    // Helper function to format date
    function formatDate(dateString) {
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      return new Date(dateString).toLocaleDateString(undefined, options);
    }

    // Initialize the application
    document.getElementById('date').value = new Date().toISOString().split('T')[0];
    loadReports();
  </script>
</body>
</html>